<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Order Details - ByteForge</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
</head>
<body class="bg-light">

<div th:replace="fragments/navigation :: navigation"></div>

<div class="container py-4">
    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a th:href="@{/admin/dashboard}">Dashboard</a></li>
            <li class="breadcrumb-item"><a th:href="@{/admin/dashboard/orders}">Orders Management</a></li>
            <li class="breadcrumb-item active" aria-current="page">Order Details</li>
        </ol>
    </nav>

    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3 mb-0">Order Details</h1>
        <div>
            <button class="btn btn-outline-secondary me-2" onclick="window.history.back()">
                <i class="bi bi-arrow-left"></i> Back
            </button>
            <button class="btn btn-success" id="completeOrderBtn">
                <i class="bi bi-check2"></i> Complete Order
            </button>
        </div>
    </div>

    <div id="loadingSpinner" class="text-center py-5">
        <output class="spinner-border text-primary" aria-live="polite">
            <span class="visually-hidden">Loading order details...</span>
        </output>
        <p class="mt-3">Loading order details...</p>
    </div>

    <div id="orderDetails" style="display: none;">
        <div class="row">
            <div class="col-lg-8">
                <!-- Order Information -->
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-white">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-info-circle me-2"></i>Order Information
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <p><strong>Order ID:</strong> <span id="orderId"></span></p>
                                <p><strong>Order Date:</strong> <span id="orderDate"></span></p>
                                <p><strong>Status:</strong> <span id="orderStatus" class="badge bg-warning text-dark">Processing</span></p>
                            </div>
                            <div class="col-md-6">
                                <p><strong>Total Amount:</strong> <span id="totalPrice" class="fw-bold"></span></p>
                                <p><strong>Payment Method:</strong> <span id="paymentMethod">Credit Card</span></p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Customer Information -->
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-white">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-person me-2"></i>Customer Information
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <p><strong>Name:</strong> <span id="customerName"></span></p>
                                <p><strong>Email:</strong> <span id="customerEmail"></span></p>
                                <p><strong>Phone:</strong> <span id="customerPhone"></span></p>
                            </div>
                            <div class="col-md-6">
                                <p><strong>Address:</strong> <span id="customerAddress"></span></p>
                                <p><strong>City:</strong> <span id="customerCity"></span></p>
                                <p><strong>Postal Code:</strong> <span id="customerPostalCode"></span></p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Order Items -->
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-white">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-cart me-2"></i>Order Items
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                <tr>
                                    <th>Product</th>
                                    <th>Price</th>
                                    <th>Quantity</th>
                                    <th>Total</th>
                                </tr>
                                </thead>
                                <tbody id="orderItemsTable">
                                <!-- Items will be populated here -->
                                </tbody>
                                <tfoot>
                                <tr>
                                    <td colspan="3" class="text-end fw-bold">Subtotal:</td>
                                    <td class="fw-bold" id="subtotalPrice"></td>
                                </tr>
                                <tr>
                                    <td colspan="3" class="text-end fw-bold">Total:</td>
                                    <td class="fw-bold" id="finalTotalPrice"></td>
                                </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-4">
                <!-- Order Actions -->
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-white">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-gear me-2"></i>Order Actions
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="d-grid gap-2">
                            <button class="btn btn-outline-primary" onclick="printOrder()">
                                <i class="bi bi-printer me-2"></i>Print Order
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Shipping Information -->
                <div class="card shadow-sm">
                    <div class="card-header bg-white">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-truck me-2"></i>Shipping Information
                        </h5>
                    </div>
                    <div class="card-body">
                        <p><strong>Shipping Method:</strong> Standard Shipping</p>
                        <p><strong>Estimated Delivery:</strong> <span id="estimatedDelivery">3-5 business days</span></p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="errorMessage" class="alert alert-danger text-center" style="display: none;">
        <i class="bi bi-exclamation-triangle me-2"></i>
        <span id="errorText">Error loading order details</span>
    </div>
</div>

<th:block th:replace="fragments/footer :: footer"></th:block>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    // Get order ID from URL
    function getOrderIdFromUrl() {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get('id');
    }

    // Format date
    function formatOrderDate(dateString) {
        const orderDate = new Date(dateString);
        return orderDate.toLocaleString('en-GB', {
            day: '2-digit',
            month: '2-digit',
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
    }

    // Format currency
    function formatCurrency(amount) {
        return `$${amount?.toFixed(2) || '0.00'}`;
    }

    // Load order details
    async function loadOrderDetails() {
        const orderId = getOrderIdFromUrl();
        const loadingSpinner = document.getElementById('loadingSpinner');
        const orderDetails = document.getElementById('orderDetails');

        try {
            // First try active orders endpoint
            let response = await fetch(`/api/orders/active/${orderId}`, {
                headers: {
                    'Accept': 'application/json'
                },
                credentials: 'include'
            });

            // If not found in active orders, try archived orders
            if (response.status === 404) {
                response = await fetch(`/api/orders/archived/${orderId}`, {
                    headers: {
                        'Accept': 'application/json'
                    },
                    credentials: 'include'
                });
            }

            if (!response.ok) {
                const errorText = await response.text();
                console.error('Error response:', errorText);
                throw new Error(`HTTP error! status: ${response.status}, body: ${errorText}`);
            }
            
            const order = await response.json();
            displayOrderDetails(order);
            
            // Hide loading spinner and show order details
            loadingSpinner.style.display = 'none';
            orderDetails.style.display = 'block';
            
        } catch (error) {
            console.error('Error loading order details:', error);
            loadingSpinner.style.display = 'none';
            showError('Failed to load order details: ' + error.message);
        }
    }

    // Function to display order details on the page
    function displayOrderDetails(order) {
        
        // Update order summary
        document.getElementById('orderId').textContent = order.id || 'N/A';
        document.getElementById('orderDate').textContent = order.date ? formatOrderDate(order.date) : 'N/A';
        document.getElementById('orderStatus').textContent = 'Processing'; // Default status since it's not in the DTO
        document.getElementById('totalPrice').textContent = order.totalPrice ? formatCurrency(order.totalPrice) : '$0.00';

        // Update customer information
        document.getElementById('customerName').textContent = `${order.firstName || ''} ${order.lastName || ''}`.trim() || 'N/A';
        document.getElementById('customerEmail').textContent = order.email || 'N/A';
        document.getElementById('customerPhone').textContent = order.phoneNumber || 'N/A';
        document.getElementById('customerAddress').textContent = order.address || 'N/A';
        document.getElementById('customerCity').textContent = order.city || 'N/A';
        document.getElementById('customerPostalCode').textContent = order.postIndex || 'N/A';

        // Update order items
        const orderItemsContainer = document.getElementById('orderItemsTable');
        orderItemsContainer.innerHTML = ''; // Clear existing items

        if (order.orderProducts && order.orderProducts.length > 0) {
            let subtotal = 0;
            
            order.orderProducts.forEach(item => {
                if (item && item.product) {
                    const itemPrice = item.product.price || 0;
                    const itemQuantity = item.quantity || 1;
                    const itemTotal = itemPrice * itemQuantity;
                    subtotal += itemTotal;
                    
                    const row = document.createElement('tr');
                    
                    // Create and append product name cell
                    const nameCell = document.createElement('td');
                    nameCell.textContent = item.product.name || 'Product';
                    row.appendChild(nameCell);
                    
                    // Create and append price cell
                    const priceCell = document.createElement('td');
                    priceCell.textContent = formatCurrency(itemPrice);
                    row.appendChild(priceCell);
                    
                    // Create and append quantity cell
                    const quantityCell = document.createElement('td');
                    quantityCell.textContent = itemQuantity;
                    row.appendChild(quantityCell);
                    
                    // Create and append total cell
                    const totalCell = document.createElement('td');
                    totalCell.textContent = formatCurrency(itemTotal);
                    row.appendChild(totalCell);
                    
                    orderItemsContainer.appendChild(row);
                }
            });
            
            // Update order totals
            document.getElementById('subtotalPrice').textContent = formatCurrency(subtotal);
            document.getElementById('finalTotalPrice').textContent = formatCurrency(order.totalPrice || subtotal);
        } else {
            const row = document.createElement('tr');
            const cell = document.createElement('td');
            cell.colSpan = 4;
            cell.className = 'text-center text-muted py-3';
            
            const icon = document.createElement('i');
            icon.className = 'bi bi-exclamation-circle me-2';
            
            const text = document.createTextNode('No items found in this order');
            
            cell.appendChild(icon);
            cell.appendChild(text);
            row.appendChild(cell);
            orderItemsContainer.appendChild(row);
        }

        // Set up complete order button
        document.getElementById('completeOrderBtn').addEventListener('click', () => completeOrder(order.id));
    }

    // Complete order
    async function completeOrder(orderId) {
        const button = document.getElementById('completeOrderBtn');
        const originalText = button.innerHTML;

        button.disabled = true;
        button.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>Completing...';

        try {
            const response = await fetch(`/api/orders/${orderId}/complete`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            });

            if (response.ok) {
                // Update status badge
                const statusBadge = document.getElementById('orderStatus');
                statusBadge.className = 'badge bg-success';
                statusBadge.textContent = 'Completed';

                // Disable complete button
                button.disabled = true;
                button.innerHTML = '<i class="bi bi-check2 me-2"></i>Order Completed';
                button.className = 'btn btn-success';

                // Show success message
                showToast('Order completed successfully!', 'success');
            } else {
                throw new Error('Failed to complete order');
            }
        } catch (error) {
            console.error('Error completing order:', error);
            button.disabled = false;
            button.innerHTML = originalText;
            showToast('Error completing order', 'error');
        }
    }

    // Utility functions
    function showToast(message, type = 'info') {
        // Simple toast implementation
        alert(`${type.toUpperCase()}: ${message}`);
    }

    function printOrder() {
        window.print();
    }

    // Helper function to safely create elements with text content
    function createElementWithText(tagName, text) {
        const element = document.createElement(tagName);
        element.textContent = text;
        return element;
    }

    // Initialize page
    document.addEventListener('DOMContentLoaded', function() {
        loadOrderDetails();
    });
</script>

<!-- User Account Script -->
<div th:replace="fragments/navigation :: user-account-script"></div>
</body>
</html>