<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Leave a Review</title>
    <th:block th:insert="~{fragments/navigation :: head-links}" />
</head>
<body>
<!-- Navigation -->
<div th:replace="fragments/navigation :: navigation"></div>

<div class="container py-4">
    <!-- Breadcrumb Navigation -->
    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a th:href="@{/profile}">Profile</a></li>
            <li class="breadcrumb-item"><a th:href="@{/reviews/my-orders}">My Orders & Reviews</a></li>
            <li class="breadcrumb-item active" aria-current="page">Leave a Review</li>
        </ol>
    </nav>
    
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header bg-light">
                    <h2 class="h4 mb-0">
                        <i class="far fa-comment-dots me-2"></i>
                        Leave a Review for <span class="text-primary" th:text="${product.name}"></span>
                    </h2>
                </div>
                <div class="card-body">
                    <div class="alert alert-danger d-none" id="errorMessage" role="alert">
                        <i class="fas fa-exclamation-circle me-2"></i>
                        <span id="errorText">Error submitting review. Please try again.</span>
                    </div>
                    <div class="alert alert-success d-none" id="successMessage" role="alert">
                        <i class="fas fa-check-circle me-2"></i>
                        Your review has been submitted and will be displayed after moderation.
                    </div>

                    <form id="reviewForm" th:action="@{/api/products/{productId}/reviews(productId=${product.id})}" method="post" class="needs-validation" novalidate>
                        <input type="hidden" id="product-id" th:value="${product.id}" name="productId">

                        <div class="mb-3">
                            <label for="rating" class="form-label">Rating</label>
                            <select id="rating" class="form-select" name="rating" required>
                                <option value="" selected disabled>Select a rating</option>
                                <option value="1">1 - Poor</option>
                                <option value="2">2 - Fair</option>
                                <option value="3">3 - Good</option>
                                <option value="4">4 - Very Good</option>
                                <option value="5">5 - Excellent</option>
                            </select>
                            <div class="invalid-feedback">
                                Please select a rating.
                            </div>
                        </div>

                        <div class="mb-4">
                            <label for="text" class="form-label">Your Review</label>
                            <textarea class="form-control" id="text" name="text" rows="5" 
                                     placeholder="Share your experience with this product" required></textarea>
                            <div class="invalid-feedback">
                                Please write your review.
                            </div>
                        </div>

                        <div class="d-flex justify-content-between align-items-center pt-3 border-top">
                            <button type="submit" class="btn btn-primary" id="submit-button">
                                <i class="far fa-paper-plane me-1"></i> Submit Review
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script th:inline="javascript">
    document.addEventListener('DOMContentLoaded', function() {
        const form = document.getElementById('reviewForm');
        const errorMessage = document.getElementById('errorMessage');
        const successMessage = document.getElementById('successMessage');
        const errorText = document.getElementById('errorText');
        const submitButton = document.getElementById('submit-button');
        
        // Form validation
        form.addEventListener('submit', function(e) {
            if (!form.checkValidity()) {
                e.preventDefault();
                e.stopPropagation();
            }
            
            form.classList.add('was-validated');
        }, false);
        
        // Form submission
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            
            if (!form.checkValidity()) {
                return;
            }
            
            // Get form data
            const formData = new FormData(form);
            const productId = document.getElementById('product-id').value;
            
            // Show loading state
            submitButton.disabled = true;
            submitButton.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Submitting...';
            
            // Hide any previous messages
            errorMessage.classList.add('d-none');
            successMessage.classList.add('d-none');
            
            // Submit review
            fetch(`/api/products/${productId}/reviews`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify({
                    rating: formData.get('rating'),
                    title: formData.get('title'),
                    text: formData.get('text')
                }),
                credentials: 'same-origin'
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(err => {
                        throw new Error(err.message || 'Error submitting review');
                    });
                }
                return response.json();
            })
            .then(data => {
                // Show success message
                successMessage.classList.remove('d-none');
                form.reset();
                form.classList.remove('was-validated');
                
                // Scroll to success message
                successMessage.scrollIntoView({ behavior: 'smooth' });
                
                // Hide success message after 5 seconds
                setTimeout(() => {
                    successMessage.classList.add('d-none');
                }, 5000);
            })
            .catch(error => {
                // Show error message
                errorText.textContent = error.message;
                errorMessage.classList.remove('d-none');
                
                // Scroll to error message
                errorMessage.scrollIntoView({ behavior: 'smooth' });
                
                // Hide error message after 5 seconds
                setTimeout(() => {
                    errorMessage.classList.add('d-none');
                }, 5000);
            })
            .finally(() => {
                // Reset button state
                submitButton.disabled = false;
                submitButton.innerHTML = '<i class="far fa-paper-plane me-2"></i>Submit Review';
            });
        });
        
        // Permission check removed as requested
    });
</script>

<!-- CSRF is disabled -->

<!-- Add footer -->
<div th:replace="fragments/footer :: footer"></div>

<!-- Bootstrap JS and dependencies -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>