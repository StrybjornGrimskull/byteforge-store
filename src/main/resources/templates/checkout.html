<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Checkout | ByteForge</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Poppins', sans-serif; background-color: #f8f9fa; }
        .confirmation-section { display: none; }
    </style>
</head>
<body>
<div th:replace="fragments/navigation :: navigation"></div>

<div class="container py-5">
    <div class="bg-white p-4 mb-4 text-center mx-auto rounded-3 shadow-sm" style="max-width: 600px;">
        <h1 class="display-5 fw-bold mb-3"><i class="bi bi-cart-check me-2"></i>CHECKOUT</h1>
        <p class="mb-0">Complete your purchase with secure checkout</p>
    </div>

    <div class="row justify-content-center">
        <div class="col-lg-8 mx-auto">
            <div id="checkout-form-container">
                <div class="card mb-4">
                    <h4 class="card-header fw-bold mb-4"><i class="bi bi-person-circle me-2"></i>Contact Information</h4>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="firstName" class="form-label"><span class="text-danger">*</span> First Name</label>
                                <input type="text" class="form-control" id="firstName" name="firstName" required>
                                <div class="invalid-feedback" id="firstNameError"></div>
                            </div>
                            <div class="col-md-6">
                                <label for="lastName" class="form-label"><span class="text-danger">*</span> Last Name</label>
                                <input type="text" class="form-control" id="lastName" name="lastName" required>
                                <div class="invalid-feedback" id="lastNameError"></div>
                            </div>
                            <div class="col-md-6">
                                <label for="email-display" class="form-label">Email</label>
                                <div class="form-control-plaintext" id="email-display" aria-labelledby="email-label"></div>
                            </div>
                            <div class="col-md-6">
                                <label for="phone" class="form-label"><span class="text-danger">*</span> Phone Number</label>
                                <input type="tel" class="form-control" id="phone" name="phoneNumber" required>
                                <div class="invalid-feedback" id="phoneError"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card mb-4">
                    <h4 class="card-header fw-bold mb-4"><i class="bi bi-truck me-2"></i>Shipping Address</h4>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-12">
                                <label for="address" class="form-label"><span class="text-danger">*</span> Address</label>
                                <input type="text" class="form-control" id="address" name="address" required>
                                <div class="invalid-feedback" id="addressError"></div>
                            </div>
                            <div class="col-md-6">
                                <label for="city" class="form-label"><span class="text-danger">*</span> City</label>
                                <input type="text" class="form-control" id="city" name="city" required>
                                <div class="invalid-feedback" id="cityError"></div>
                            </div>
                            <div class="col-md-6">
                                <label for="postIndex" class="form-label"><span class="text-danger">*</span> Postal Code</label>
                                <input type="number" class="form-control" id="postIndex" name="postIndex" required>
                                <div class="invalid-feedback" id="postIndexError"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="d-flex justify-content-between mt-4">
                    <a href="/shopping-cart" class="btn btn-outline-secondary">
                        <i class="bi bi-arrow-left me-1"></i> Back to Cart
                    </a>
                    <button id="place-order-btn" class="btn btn-primary px-4">
                        Place Order <i class="bi bi-arrow-right ms-1"></i>
                    </button>
                </div>
            </div>

            <div id="order-confirmation" class="confirmation-section">
                <div class="bg-white p-4 text-center mx-auto rounded-3 shadow-sm" style="max-width: 600px;">
                    <div class="mb-4">
                        <i class="bi bi-check-circle-fill text-success" style="font-size: 4rem;"></i>
                    </div>
                    <h3 class="fw-bold mb-3">Thank you for your order!</h3>
                    <p class="mb-4">Your order has been placed successfully. We've sent a confirmation email to <span id="confirmation-email" class="fw-bold"></span></p>

                    <div class="card mb-4">
                        <div class="card-header bg-light">
                            <h5 class="mb-0">Order Summary</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <h6 class="fw-bold">Order Number</h6>
                                    <p id="order-number">Loading...</p>
                                    <h6 class="fw-bold">Order Date</h6>
                                    <p id="order-date">Loading...</p>
                                </div>
                                <div class="col-md-6">
                                    <h6 class="fw-bold">Shipping Address</h6>
                                    <p id="shipping-address">Loading...</p>
                                </div>
                            </div>
                            <hr>
                            <h6 class="fw-bold mb-3">Items Ordered</h6>
                            <div id="ordered-items"></div>
                            <hr>
                            <div class="row">
                                <div class="col-md-6">
                                    <h6 class="fw-bold">Delivery Method</h6>
                                    <p>Standard Delivery (3-5 business days)</p>
                                </div>
                                <div class="col-md-6 text-end">
                                    <h6 class="fw-bold">Total</h6>
                                    <h4 id="order-total">$0.00</h4>
                                </div>
                            </div>
                        </div>
                    </div>

                    <a href="/" class="btn btn-primary">
                        <i class="bi bi-house-door me-1"></i> Back to Home
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<th:block th:replace="fragments/footer :: footer"></th:block>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    $(function() {

        function showFieldError(field, message) {
            const fieldMap = {
                'phoneNumber': 'phone',
                'firstName': 'firstName',
                'lastName': 'lastName',
                'city': 'city',
                'address': 'address',
                'postIndex': 'postIndex'
            };

            const fieldId = fieldMap[field] || field;
            const $field = $(`#${fieldId}`);
            const $errorElement = $(`#${fieldId}Error`);

            if ($field.length && $errorElement.length) {
                $field.addClass('is-invalid');
                $errorElement.text(message);

                $('html, body').animate({
                    scrollTop: $field.offset().top - 100
                }, 500);

                $field.focus();
            }
        }

        function clearValidationErrors() {
            $('.is-invalid').removeClass('is-invalid');
            $('.invalid-feedback').text('');
        }

        function loadProfileData() {
            $.get('/api/profile', function(profile) {
                if (profile) {
                    $('#firstName').val(profile.firstName || '');
                    $('#lastName').val(profile.lastName || '');
                    $('#email-display').text(profile.email || '');
                    $('#phone').val(profile.phone || '');
                    $('#city').val(profile.city || '');
                    $('#address').val(profile.address || '');
                    $('#postIndex').val(profile.postIndex || '');
                }
            }).fail(function() {
            });
        }

        function placeOrder(orderData, $btn) {
            $.ajax({
                url: '/api/orders',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(orderData),
                success: function(response) {
                    showOrderConfirmation(response, orderData);
                    $btn.prop('disabled', false).text('Place Order');
                },
                error: function(xhr) {
                    handleOrderError(xhr);
                    $btn.prop('disabled', false).text('Place Order');
                }
            });
        }

        function handleOrderError(xhr) {
            let errorMessage = 'An error occurred. Please try again.';
            let hasFieldErrors = false;

            try {
                if (xhr.status === 400 && xhr.responseText) {
                    const errorResponse = JSON.parse(xhr.responseText);
                    if (errorResponse.errors && Array.isArray(errorResponse.errors)) {
                        errorResponse.errors.forEach(error => {
                            if (error.field && error.defaultMessage) {
                                showFieldError(error.field, error.defaultMessage);
                                hasFieldErrors = true;
                            }
                        });
                    }
                    if (errorResponse.message && !hasFieldErrors) {
                        errorMessage = errorResponse.message;
                    }
                }
            } catch (e) {
                console.error('Error processing error response:', e);
                if (xhr.responseText.includes('Numeric value') && xhr.responseText.includes('out of range')) {
                    showFieldError('postIndex', 'Invalid post index');
                    hasFieldErrors = true;
                } else {
                    errorMessage = 'Error processing your request';
                }
            }

            if (!hasFieldErrors) {
                alert(errorMessage);
            }
        }

        function showOrderConfirmation(order, orderData) {
            $('#checkout-form-container').hide();
            $('#order-confirmation').show();
            $('#order-number').text('#' + (order.id || '0000'));
            $('#order-date').text(new Date(order.createdAt || Date.now()).toLocaleString());
            $('#shipping-address').html(`
            ${orderData.firstName} ${orderData.lastName}<br>
            ${orderData.address}<br>
            ${orderData.city}, ${orderData.postIndex}
        `);
            $('#confirmation-email').text(orderData.email);

            if (order.orderProducts && order.orderProducts.length > 0) {
                let itemsHtml = '';
                let total = 0;

                order.orderProducts.forEach(item => {
                    const product = item.product;
                    const itemTotal = product.price * item.quantity;
                    total += itemTotal;

                    itemsHtml += `
                    <div class="d-flex mb-3">
                        <div class="me-3" style="width: 60px; height: 60px; background: #f8f9fa; display: flex; align-items: center; justify-content: center;">
                            <img src="/uploads/${product.imageUrl}" alt="${product.name}" style="max-width: 100%; max-height: 100%;">
                        </div>
                        <div class="flex-grow-1">
                            <div>${product.name}</div>
                            <small>Qty: ${item.quantity}</small>
                        </div>
                        <div>$${itemTotal.toFixed(2)}</div>
                    </div>`;
                });

                $('#ordered-items').html(itemsHtml);
                $('#order-total').text('$' + total.toFixed(2));
            }
        }

        $('#place-order-btn').click(function() {
            const $btn = $(this);
            clearValidationErrors();

            $btn.prop('disabled', true).text('Processing...');

            const orderData = {
                firstName: $('#firstName').val().trim(),
                lastName: $('#lastName').val().trim(),
                email: $('#email-display').text().trim(),
                phoneNumber: $('#phone').val().trim(),
                city: $('#city').val().trim(),
                address: $('#address').val().trim(),
                postIndex: $('#postIndex').val().trim() // Отправляем как строку
            };

            placeOrder(orderData, $btn);
        });

        loadProfileData();
    });
</script>

<div th:replace="fragments/navigation :: user-account-script"></div>

</body>
</html>