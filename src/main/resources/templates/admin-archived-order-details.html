<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Archived Order Details - ByteForge</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
</head>
<body class="bg-light">

<div th:replace="fragments/navigation :: navigation"></div>

<div class="container py-4">
    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a th:href="@{/admin/dashboard}">Dashboard</a></li>
            <li class="breadcrumb-item"><a th:href="@{/admin/dashboard/orders/archived}">Archived Orders</a></li>
            <li class="breadcrumb-item active" aria-current="page">Archived Order Details</li>
        </ol>
    </nav>

    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3 mb-0">
            <i class="bi bi-archive me-2"></i>Archived Order Details
            <span class="ms-2 badge bg-secondary">Archived</span>
        </h1>
        <div>
            <button class="btn btn-outline-secondary me-2" onclick="window.history.back()">
                <i class="bi bi-arrow-left"></i> Back
            </button>
        </div>
    </div>

    <output id="loadingSpinner" class="text-center py-5 d-none">
        <div class="spinner-border text-primary" aria-hidden="true"></div>
        <p class="mt-3">Loading order details...</p>
    </output>

    <div id="orderDetails" class="d-none">
        <div class="row">
            <div class="col-lg-8">
                <!-- Order Information -->
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-white">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-info-circle me-2"></i>Order Information
                        </h5>
                    </div>
                    <div class="card-body">
                        <p><strong>Order ID:</strong> <span id="orderId"></span></p>
                        <p><strong>Order Date:</strong> <span id="orderDate"></span></p>
                        <p><strong>Status:</strong> <span id="orderStatus" class="badge bg-secondary">Archived</span></p>
                    </div>
                </div>

                <!-- Customer Information -->
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-white">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-person me-2"></i>Customer Information
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <p><strong>Name:</strong> <span id="customerName"></span></p>
                                <p><strong>Email:</strong> <span id="customerEmail"></span></p>
                                <p><strong>Phone:</strong> <span id="customerPhone"></span></p>
                            </div>
                            <div class="col-md-6">
                                <p><strong>Address:</strong> <span id="customerAddress"></span></p>
                                <p><strong>City:</strong> <span id="customerCity"></span></p>
                                <p><strong>Postal Code:</strong> <span id="customerPostalCode"></span></p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Order Items -->
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-white">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-cart me-2"></i>Order Items
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                <tr>
                                    <th>Product</th>
                                    <th>Price</th>
                                    <th>Quantity</th>
                                    <th>Total</th>
                                </tr>
                                </thead>
                                <tbody id="orderItemsTable">
                                <!-- Items will be populated here -->
                                </tbody>
                                <tfoot>
                                <tr>
                                    <td colspan="3" class="text-end fw-bold">Subtotal:</td>
                                    <td class="fw-bold" id="subtotalPrice"></td>
                                </tr>
                                <tr>
                                    <td colspan="3" class="text-end fw-bold">Total:</td>
                                    <td class="fw-bold" id="finalTotalPrice"></td>
                                </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-4">
                <!-- Order Actions -->
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-white">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-archive me-2"></i>Archive Actions
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="d-grid gap-2">
                            <button class="btn btn-outline-primary" onclick="printOrder()">
                                <i class="bi bi-printer me-2"></i>Print Order
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Shipping Information -->
                <div class="card shadow-sm">
                    <div class="card-header bg-white">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-truck me-2"></i>Shipping Information
                        </h5>
                    </div>
                    <div class="card-body">
                        <p><strong>Shipping Method:</strong> <span id="shippingMethod">Standard Shipping</span></p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="errorMessage" class="alert alert-danger text-center" style="display: none;">
        <i class="bi bi-exclamation-triangle me-2"></i>
        <span id="errorText">Error loading order details</span>
    </div>
</div>

<th:block th:replace="fragments/footer :: footer"></th:block>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    function getOrderIdFromUrl() {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get('id');
    }

    function formatOrderDate(dateString) {
        if (!dateString) return '';
        const options = {
            year: 'numeric',
            month: 'short',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        };
        return new Date(dateString).toLocaleDateString('en-US', options);
    }

    function formatCurrency(amount) {
        if (amount === undefined || amount === null) return '$0.00';
        return '$' + parseFloat(amount).toFixed(2);
    }

    async function loadOrderDetails() {
        const orderId = getOrderIdFromUrl();
        if (!orderId) {
            showError('No order ID provided');
            return;
        }

        // Show loading spinner
        document.getElementById('loadingSpinner').classList.remove('d-none');
        document.getElementById('orderDetails').classList.add('d-none');

        try {
            const response = await fetch(`/api/orders/archived/${orderId}`, {
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json'
                }
            });

            if (!response.ok) {
                showError('Failed to load order details');
                return;
            }

            try {
                const order = await response.json();
                displayOrderDetails(order);
            } catch (error) {
                console.error('Error parsing order details:', error);
                showError('Error processing order details');
            }
        } catch (error) {
            console.error('Error loading order details:', error);
            showError('Failed to load order details. Please try again later.');
        }
    }

    function displayOrderDetails(order) {
        console.log('Order object:', order); // Debug log
        if (!order) {
            showError('No order data received');
            return;
        }

        // Hide loading spinner and show order details
        document.getElementById('loadingSpinner').classList.add('d-none');
        document.getElementById('orderDetails').classList.remove('d-none');

        try {
            // Order Information
            document.getElementById('orderId').textContent = order.id || 'N/A';
            document.getElementById('orderDate').textContent = formatOrderDate(order.date);
            // Removed totalPrice display from order information

            // Customer Information
            document.getElementById('customerName').textContent = `${order.firstName || ''} ${order.lastName || ''}`.trim() || 'Guest';
            document.getElementById('customerEmail').textContent = order.email || 'N/A';
            document.getElementById('customerPhone').textContent = order.phoneNumber || 'N/A';

            // Address Information
            document.getElementById('customerAddress').textContent = order.address || 'Not specified';
            document.getElementById('customerCity').textContent = order.city || 'Not specified';
            document.getElementById('customerPostalCode').textContent = order.postIndex || 'Not specified';

            // Order Items
            const orderItemsContainer = document.getElementById('orderItemsTable');
            orderItemsContainer.innerHTML = '';

            // Calculate subtotal from order items
            let subtotal = 0;

            if (order.orderProducts && order.orderProducts.length > 0) {
                order.orderProducts.forEach(item => {
                    const row = document.createElement('tr');
                    const itemPrice = item.product?.price || 0;
                    const quantity = item.quantity || 1;
                    const itemTotal = itemPrice * quantity;
                    subtotal += itemTotal;

                    row.innerHTML = `
                        <td>${item.product?.name || 'Unknown Product'}</td>
                        <td>${formatCurrency(itemPrice)}</td>
                        <td>${quantity}</td>
                        <td>${formatCurrency(itemTotal)}</td>
                    `;
                    orderItemsContainer.appendChild(row);
                });
            } else {
                const row = document.createElement('tr');
                row.innerHTML = '<td colspan="4" class="text-center">No items in this order</td>';
                orderItemsContainer.appendChild(row);
            }

            // Update order summary
            const total = order.totalPrice || subtotal;

            document.getElementById('subtotalPrice').textContent = formatCurrency(subtotal);
            document.getElementById('finalTotalPrice').textContent = formatCurrency(total);
            
        } catch (error) {
            console.error('Error displaying order details:', error);
            showError('Error displaying order details. Please try again.');
        }
    }

    function showError(message) {
        document.getElementById('loadingSpinner').classList.add('d-none');
        document.getElementById('errorText').textContent = message;
        document.getElementById('errorMessage').style.display = 'block';
    }

    function printOrder() {
        window.print();
    }

    // Initialize page
    document.addEventListener('DOMContentLoaded', function() {
        loadOrderDetails();
    });
</script>
<!-- User Account Script -->
<div th:replace="fragments/navigation :: user-account-script"></div>
</body>
</html>