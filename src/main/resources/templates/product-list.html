<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Product List</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        .loading-spinner {
            display: none;
            text-align: center;
            padding: 20px;
        }
        .product-image {
            max-width: 80px;
            max-height: 80px;
            object-fit: contain;
        }
        .filter-card {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .price-cell {
            white-space: nowrap;
        }
        .debug-panel {
            background-color: #f0f0f0;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
<div class="container mt-4">
    <!-- Отладочная панель -->
    <div class="debug-panel">
        <h5>Debug Information</h5>
        <div class="row">
            <div class="col-md-3">
                <p>Category ID: <strong id="debugCategoryId"></strong></p>
            </div>
            <div class="col-md-3">
                <p>Brand ID: <strong id="debugBrandId"></strong></p>
            </div>
            <div class="col-md-3">
                <p>Min Price: <strong id="debugMinPrice"></strong></p>
            </div>
            <div class="col-md-3">
                <p>Max Price: <strong id="debugMaxPrice"></strong></p>
            </div>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col">
            <h1 class="display-6">Product Catalog</h1>
            <hr>
        </div>
    </div>

    <!-- Фильтры -->
    <div class="filter-card shadow-sm mb-4">
        <form id="filterForm">
            <input type="hidden" name="categoryId" th:value="${categoryId}">
            <div class="row g-3">
                <div class="col-md-4">
                    <label for="brandId" class="form-label">Brand</label>
                    <select id="brandId" name="brandId" class="form-select">
                        <option value="">All Brands</option>
                        <option th:each="brand : ${brands}"
                                th:value="${brand.id}"
                                th:text="${brand.name}"
                                th:selected="${brandId == brand.id}"></option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label class="form-label">Price Range</label>
                    <div class="input-group">
                        <input type="number" id="minPriceInput" name="minPrice" class="form-control" placeholder="Min"
                               th:value="${minPrice}" step="0.01" min="0">
                        <span class="input-group-text">to</span>
                        <input type="number" id="maxPriceInput" name="maxPrice" class="form-control" placeholder="Max"
                               th:value="${maxPrice}" step="0.01" min="0">
                    </div>
                </div>
                <div class="col-md-4 d-flex align-items-end">
                    <button type="submit" class="btn btn-primary me-2" id="applyFilterBtn">
                        <i class="fas fa-filter me-1"></i> Apply Filters
                    </button>
                    <button type="button" id="resetFilters" class="btn btn-outline-secondary">
                        <i class="fas fa-undo me-1"></i> Reset
                    </button>
                </div>
            </div>
        </form>
    </div>

    <!-- Спиннер загрузки -->
    <div id="loadingSpinner" class="loading-spinner">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-2">Loading products...</p>
    </div>

    <!-- Таблица продуктов -->
    <div id="productTable" class="table-responsive">
        <!-- Динамически загружаемый контент -->
    </div>

    <!-- Пагинация -->
    <div id="pagination" class="d-flex justify-content-center mt-4">
        <!-- Динамически загружаемая пагинация -->
    </div>
</div>

<script>
    $(document).ready(function() {
        // Инициализация и первая загрузка
        updateDebugInfo();
        loadProducts(0);

        // Обработчик отправки формы
        $('#filterForm').on('submit', function(e) {
            e.preventDefault();
            console.log("Form submitted");
            loadProducts(0);
        });

        // Обработчик изменений в фильтрах
        $('#brandId, #minPriceInput, #maxPriceInput').on('change', function() {
            updateDebugInfo();
        });

        // Кнопка сброса
        $('#resetFilters').click(function() {
            $('#brandId').val('');
            $('#minPriceInput').val('');
            $('#maxPriceInput').val('');
            updateDebugInfo();
            loadProducts(0);
        });
    });

    // Функция обновления отладочной информации
    function updateDebugInfo() {
        $('#debugCategoryId').text($('input[name="categoryId"]').val() || 'null');
        $('#debugBrandId').text($('#brandId').val() || 'null');
        $('#debugMinPrice').text($('#minPriceInput').val() || 'null');
        $('#debugMaxPrice').text($('#maxPriceInput').val() || 'null');
    }

    // Функция загрузки продуктов
    function loadProducts(page) {
        console.log("Loading products, page:", page);

        $('#loadingSpinner').show();
        $('#productTable').hide();
        $('#pagination').hide();

        // Формируем параметры запроса
        const params = {
            categoryId: $('input[name="categoryId"]').val(),
            brandId: $('#brandId').val(),
            minPrice: $('#minPriceInput').val(),
            maxPrice: $('#maxPriceInput').val(),
            page: page
        };

        // Удаляем пустые параметры
        Object.keys(params).forEach(key => {
            if (params[key] === '' || params[key] === undefined) {
                delete params[key];
            }
        });

        console.log("Request params:", params);

        $.get({
            url: '/products/mvc/list/json',
            data: params,
            success: function(data) {
                console.log("Response data:", data);
                renderProducts(data.content);
                renderPagination(data);
            },
            error: function(xhr) {
                console.error("Request failed:", xhr);
                $('#productTable').html(`
          <div class="alert alert-danger">
            <i class="fas fa-exclamation-triangle me-2"></i>
            Error loading products. Status: ${xhr.status}
          </div>
        `);
            },
            complete: function() {
                $('#loadingSpinner').hide();
                $('#productTable').show();
            }
        });
    }

    // Функция отрисовки продуктов
    function renderProducts(products) {
        console.log("Rendering products:", products);

        if (!products || products.length === 0) {
            $('#productTable').html(`
        <div class="alert alert-info">
          <i class="fas fa-info-circle me-2"></i>
          No products found matching your criteria.
        </div>
      `);
            return;
        }

        let html = `
      <table class="table table-hover align-middle">
        <thead class="table-light">
          <tr>
            <th>Image</th>
            <th>Name</th>
            <th>Brand</th>
            <th class="text-end">Price</th>
            <th>Stock</th>
          </tr>
        </thead>
        <tbody>
    `;

        products.forEach(function(product) {
            const imageUrl = product.imageUrl
                ? (product.imageUrl.startsWith('http') ? product.imageUrl : '/uploads/' + product.imageUrl)
                : 'https://via.placeholder.com/80';

            html += `
        <tr>
          <td>
            <img src="${imageUrl}"
                 alt="${product.name}"
                 class="product-image rounded"
                 onerror="this.src='https://via.placeholder.com/80'">
          </td>
          <td>${product.name || 'N/A'}</td>
          <td>${product.brandName || 'N/A'}</td>
          <td class="text-end">$${(product.price || 0).toFixed(2)}</td>
          <td>${product.stockQuantity || 0}</td>
        </tr>
      `;
        });

        html += `
        </tbody>
      </table>
    `;

        $('#productTable').html(html);
    }

    // Функция отрисовки пагинации
    function renderPagination(page) {
        console.log("Rendering pagination:", page);

        if (!page || page.totalPages <= 1) {
            $('#pagination').html('');
            return;
        }

        let html = `
      <nav aria-label="Page navigation">
        <ul class="pagination">
          <li class="page-item ${page.first ? 'disabled' : ''}">
            <a class="page-link" href="#" onclick="loadProducts(${page.number - 1}); return false;">
              &laquo;
            </a>
          </li>
    `;

        // Отображаем до 5 страниц вокруг текущей
        let startPage = Math.max(0, page.number - 2);
        let endPage = Math.min(page.totalPages - 1, page.number + 2);

        if (startPage > 0) {
            html += `<li class="page-item"><a class="page-link" href="#" onclick="loadProducts(0); return false;">1</a></li>`;
            if (startPage > 1) html += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
        }

        for (let i = startPage; i <= endPage; i++) {
            html += `
        <li class="page-item ${page.number === i ? 'active' : ''}">
          <a class="page-link" href="#" onclick="loadProducts(${i}); return false;">${i + 1}</a>
        </li>
      `;
        }

        if (endPage < page.totalPages - 1) {
            if (endPage < page.totalPages - 2) html += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
            html += `
        <li class="page-item">
          <a class="page-link" href="#" onclick="loadProducts(${page.totalPages - 1}); return false;">${page.totalPages}</a>
        </li>
      `;
        }

        html += `
          <li class="page-item ${page.last ? 'disabled' : ''}">
            <a class="page-link" href="#" onclick="loadProducts(${page.number + 1}); return false;">
              &raquo;
            </a>
          </li>
        </ul>
      </nav>
    `;

        $('#pagination').html(html);
    }
</script>

<!-- Bootstrap 5 JS Bundle with Popper -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>