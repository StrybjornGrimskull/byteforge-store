<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <title>Продукты</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
  <style>
    .loading-spinner {
      display: none;
      width: 2rem;
      height: 2rem;
      border: 0.25rem solid #f3f3f3;
      border-top: 0.25rem solid #3498db;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 20px auto;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
<div class="container mt-4">
  <div class="row">
    <!-- Фильтры -->
    <div class="col-md-3">
      <div class="card mb-4">
        <div class="card-body">
          <h5 class="card-title">Фильтры</h5>

          <!-- Фильтр по брендам -->
          <div class="mb-3">
            <h6>Бренды</h6>
            <div th:each="brand : ${brands}">
              <div class="form-check">
                <input class="form-check-input brand-filter"
                       type="checkbox"
                       th:id="${'brand-' + brand.id}"
                       th:value="${brand.id}">
                <label class="form-check-label" th:text="${brand.name}"
                       th:for="${'brand-' + brand.id}"></label>
              </div>
            </div>
          </div>

          <!-- Фильтр по цене -->
          <div class="mb-3">
            <h6>Цена</h6>
            <div class="row">
              <div class="col">
                <input type="number" class="form-control min-price" placeholder="Мин">
              </div>
              <div class="col">
                <input type="number" class="form-control max-price" placeholder="Макс">
              </div>
            </div>
          </div>

          <!-- Фильтр по году -->
          <div class="mb-3">
            <h6>Год выпуска</h6>
            <input type="number" class="form-control release-year" placeholder="Год">
          </div>

          <!-- Кнопки фильтров -->
          <div class="d-flex justify-content-between">
            <button class="btn btn-primary" onclick="applyFilters()">Применить</button>
            <button class="btn btn-outline-secondary" onclick="resetFilters()">Сбросить</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Список продуктов -->
    <div class="col-md-9">
      <div id="loading-spinner" class="loading-spinner"></div>
      <div class="row" id="products-container">
        <div th:each="product : ${products}" class="col-md-4 mb-4">
          <div class="card h-100">
            <img th:src="${product.imageUrl}" class="card-img-top" alt="Product image" style="height: 200px; object-fit: contain;">
            <div class="card-body">
              <h5 class="card-title" th:text="${product.name}"></h5>
              <p class="card-text" th:text="${product.price + ' ₽'}"></p>
              <p class="card-text text-muted small" th:text="${product.brandName}"></p>
              <p class="card-text" th:text="${product.shortDescription}"></p>
            </div>
          </div>
        </div>
      </div>

      <!-- Сообщение, если продукты не найдены -->
      <div th:if="${products.isEmpty()}" class="text-center py-4">
        <h5>Продукты не найдены</h5>
        <p>Попробуйте изменить параметры фильтрации</p>
      </div>
    </div>
  </div>
</div>

<script>
  function applyFilters() {
    const loadingSpinner = document.getElementById('loading-spinner');
    loadingSpinner.style.display = 'block';

    const categoryId = document.getElementById('products-container').dataset.categoryId;
    const brandIds = Array.from(document.querySelectorAll('.brand-filter:checked'))
            .map(el => parseInt(el.value));
    const minPrice = document.querySelector('.min-price').value;
    const maxPrice = document.querySelector('.max-price').value;
    const releaseYear = document.querySelector('.release-year').value;

    const params = new URLSearchParams();
    if (brandIds.length) params.append('brandIds', brandIds.join(','));
    if (minPrice) params.append('minPrice', minPrice);
    if (maxPrice) params.append('maxPrice', maxPrice);
    if (releaseYear) params.append('releaseYear', releaseYear);

    axios.get(`/products/category/${categoryId}?${params.toString()}`, {
      headers: {
        'X-Requested-With': 'XMLHttpRequest'
      }
    })
            .then(response => {
              document.getElementById('products-container').innerHTML = response.data;
            })
            .catch(error => {
              console.error('Error:', error);
              alert('Произошла ошибка при загрузке данных');
            })
            .finally(() => {
              loadingSpinner.style.display = 'none';
            });
  }

  function resetFilters() {
    document.querySelectorAll('.brand-filter').forEach(checkbox => {
      checkbox.checked = false;
    });
    document.querySelector('.min-price').value = '';
    document.querySelector('.max-price').value = '';
    document.querySelector('.release-year').value = '';
    applyFilters();
  }

  // Применяем фильтры при изменении полей
  document.querySelectorAll('.brand-filter').forEach(checkbox => {
    checkbox.addEventListener('change', applyFilters);
  });

  // Дебаунс для полей ввода
  let timeout;
  document.querySelectorAll('.min-price, .max-price, .release-year').forEach(input => {
    input.addEventListener('input', () => {
      clearTimeout(timeout);
      timeout = setTimeout(applyFilters, 500);
    });
  });
</script>
</body>
</html>